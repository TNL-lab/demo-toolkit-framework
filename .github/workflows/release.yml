name: Phase Release Automation

permissions:
  contents: write

env:
  TOOLKIT_ROOT: tools/git/git-toolkit
  TOOLKIT_SCRIPTS: tools/git/git-toolkit/scripts
  RELEASE_BRANCH: master

on:
  push:
    tags:
      - "*toolkit-*"

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # BẮT BUỘC để đọc tag & commit history
          submodules: recursive

      - name: Init submodule (read-only)
        run: |
          git submodule update --init --depth 1

      - name: Debug repo structure
        run: |
          pwd
          ls -la
          echo "Toolkit root:"
          ls -la "${{ env.TOOLKIT_ROOT }}" || true
          echo "Toolkit scripts:"
          ls -la "${{ env.TOOLKIT_SCRIPTS }}" || true

      - name: Setup tools permission
        run: |
          find "${{ env.TOOLKIT_SCRIPTS }}" -type f -name "*.sh" -exec chmod +x {} \;

      - name: Generate CHANGELOG
        run: |
          "${{ env.TOOLKIT_SCRIPTS }}/gen-changelog.sh"

      - name: Checkout release branch for commit
        run: |
          git fetch origin "${{ env.RELEASE_BRANCH }}"
          git checkout -B "${{ env.RELEASE_BRANCH }}" origin/"${{ env.RELEASE_BRANCH }}"

      - name: Debug git status
        run: |
          git status
          git submodule status

      - name: Commit CHANGELOG if changed
        run: |
          git config user.name "qa-release-bot"
          git config user.email "qa-release-bot@users.noreply.github.com"
          if ! git diff --quiet CHANGELOG.md; then
            git add CHANGELOG.md
            git commit -m "chore(release): update changelog for ${{ github.ref_name }}"
            git push origin "${{ env.RELEASE_BRANCH }}"
          else
            echo "✅ No changes to commit."
          fi
